import { cfimg, CFIMG_THUMB } from './utils/cfimg.mjs';
import { log, createCorrelationId } from './utils/logger.mjs';
import { showOffcanvas } from './modules/bootstrap.mjs';

const PRODUCT_DATA_GLOBAL_KEY = '__PRODUCT_DATA__';
let sharedProductData = null;

const UTILITY_CLASSES = Object.freeze({
    hidden: 'is-hidden',
    flex: 'is-flex',
    block: 'is-block',
    contentVisible: 'has-content-visibility',
    containIntrinsic: 'has-contain-intrinsic'
});

const PRODUCT_IMAGE_WIDTHS = Object.freeze([200, 320, 400]);
const PRODUCT_IMAGE_SIZES = '(min-width: 1200px) 280px, (min-width: 992px) 240px, (min-width: 576px) 45vw, 80vw';
const CART_IMAGE_WIDTHS = Object.freeze([80, 120, 160]);

const normaliseAssetPath = (value = '') => {
    if (!value) {
        return '';
    }
    const trimmed = value.startsWith('/') ? value.slice(1) : value;
    return `/${trimmed}`;
};

const buildCfSrc = (assetPath, extraOpts = {}) => {
    const normalised = normaliseAssetPath(assetPath);
    if (!normalised) {
        return '';
    }
    return cfimg(normalised, { ...CFIMG_THUMB, ...extraOpts });
};

const buildCfSrcset = (assetPath, extraOpts = {}, widths = PRODUCT_IMAGE_WIDTHS) => {
    const normalised = normaliseAssetPath(assetPath);
    if (!normalised) {
        return '';
    }
    return widths
        .map(width => `${cfimg(normalised, { ...CFIMG_THUMB, width, ...extraOpts })} ${width}w`)
        .join(', ');
};

const STATIC_SRC_DESCRIPTOR_KEYS = Object.freeze(['descriptor', 'd']);

const encodeStaticPath = (path) => {
    if (!path) {
        return '';
    }
    try {
        return encodeURI(path);
    } catch (_err) {
        return path;
    }
};

const buildStaticSrcset = (assetPath) => {
    if (!assetPath) {
        return '';
    }

    const normaliseDescriptor = (descriptorCandidate) => {
        if (typeof descriptorCandidate === 'string') {
            const trimmed = descriptorCandidate.trim();
            return trimmed ? trimmed : '';
        }
        if (typeof descriptorCandidate === 'number' && Number.isFinite(descriptorCandidate)) {
            return `${descriptorCandidate}w`;
        }
        return '';
    };

    const buildEntry = (entry) => {
        if (typeof entry === 'string') {
            const normalised = normaliseAssetPath(entry);
            return encodeStaticPath(normalised);
        }

        if (entry && typeof entry === 'object') {
            const srcCandidate = entry.src || entry.path || entry.url || '';
            const src = normaliseAssetPath(srcCandidate);
            if (!src) {
                return '';
            }

            const descriptorKey = STATIC_SRC_DESCRIPTOR_KEYS.find(key => key in entry);
            const descriptor = descriptorKey ? normaliseDescriptor(entry[descriptorKey]) : normaliseDescriptor(entry.width);
            const encodedSrc = encodeStaticPath(src);
            return descriptor ? `${encodedSrc} ${descriptor}` : encodedSrc;
        }

        return '';
    };

    if (Array.isArray(assetPath)) {
        return assetPath
            .map(buildEntry)
            .filter(Boolean)
            .join(', ');
    }

    if (assetPath && typeof assetPath === 'object') {
        if (typeof assetPath.srcset === 'string') {
            const trimmed = assetPath.srcset.trim();
            if (trimmed) {
                return trimmed;
            }
        }

        if (Array.isArray(assetPath.variants)) {
            return assetPath.variants
                .map(buildEntry)
                .filter(Boolean)
                .join(', ');
        }

        return buildEntry(assetPath);
    }

    const normalised = normaliseAssetPath(assetPath);
    return encodeStaticPath(normalised);
};

const isAvifAsset = (assetPath) => {
    if (typeof assetPath !== 'string') {
        return false;
    }
    const trimmed = assetPath.trim();
    if (!trimmed) {
        return false;
    }
    return /\.avif(?:[?#].*)?$/i.test(trimmed);
};

const resolveAvifSrcset = (assetPath, widths = PRODUCT_IMAGE_WIDTHS) => {
    if (!assetPath) {
        return '';
    }

    if (Array.isArray(assetPath)) {
        const staticSrcset = buildStaticSrcset(assetPath);
        if (staticSrcset && /\.avif/i.test(staticSrcset)) {
            return staticSrcset;
        }
    }

    if (assetPath && typeof assetPath === 'object' && !Array.isArray(assetPath)) {
        const srcsetFromObject = buildStaticSrcset(assetPath);
        if (srcsetFromObject && /\.avif/i.test(srcsetFromObject)) {
            return srcsetFromObject;
        }

        const srcCandidate = assetPath.src || assetPath.path || assetPath.url || '';
        if (isAvifAsset(srcCandidate)) {
            return buildStaticSrcset(srcCandidate);
        }
    }

    if (isAvifAsset(assetPath)) {
        return buildStaticSrcset(assetPath);
    }

    return buildCfSrcset(assetPath, { format: 'avif' }, widths);
};
function getSharedProductData() {
    if (typeof window !== 'undefined') {
        const payload = window[PRODUCT_DATA_GLOBAL_KEY];
        if (payload && Array.isArray(payload.products)) {
            return payload;
        }
    }
    if (sharedProductData && Array.isArray(sharedProductData.products)) {
        return sharedProductData;
    }
    return null;
}

function writeSharedProductData(products, metadata = {}, { force = false } = {}) {
    if (!Array.isArray(products)) {
        return null;
    }
    const payload = {
        products,
        version: metadata.version || null,
        source: metadata.source || null,
        updatedAt: metadata.updatedAt || Date.now(),
        isPartial: Boolean(metadata.isPartial),
        total: typeof metadata.total === 'number' ? metadata.total : null
    };
    const existing = getSharedProductData();
    if (existing && !force) {
        const existingVersion = existing.version || null;
        const payloadVersion = payload.version || null;
        const shouldKeepExisting =
            (!payloadVersion && existingVersion) ||
            (!payloadVersion && !existingVersion) ||
            (payloadVersion && existingVersion === payloadVersion);
        if (shouldKeepExisting) {
            return existing;
        }
    }
    sharedProductData = payload;
    if (typeof window !== 'undefined') {
        window[PRODUCT_DATA_GLOBAL_KEY] = { ...payload };
    }
    return payload;
}

function ensureSharedProductData(products, metadata = {}) {
    return writeSharedProductData(products, metadata, { force: false });
}

function overwriteSharedProductData(products, metadata = {}) {
    return writeSharedProductData(products, metadata, { force: true });
}

// Service Worker Configuration and Initialization
const SERVICE_WORKER_CONFIG = {
    path: '/service-worker.js',
    scope: '/',
    updateCheckInterval: 5 * 60 * 1000, // 5 minutes
};

const LOCALHOST_HOSTNAMES = new Set(['localhost', '127.0.0.1', '::1', '[::1]']);

function safeReadLocalStorage(key) {
    if (typeof window === 'undefined') {
        return null;
    }

    try {
        const storage = window.localStorage ?? globalThis.localStorage ?? null;
        if (!storage) {
            return null;
        }
        return storage.getItem(key);
    } catch (error) {
        console.warn('Unable to access localStorage for key', key, error);
        return null;
    }
}

function shouldRegisterServiceWorker() {
    if (typeof window === 'undefined') {
        return false;
    }

    const disabledFlag = safeReadLocalStorage('ebano-sw-disabled');
    if (disabledFlag === 'true') {
        console.info('Service worker registration skipped by kill-switch flag.');
        return false;
    }

    const hostname = window.location?.hostname ?? '';
    const isLocalhost = LOCALHOST_HOSTNAMES.has(hostname);
    if (isLocalhost) {
        const enableLocalFlag = safeReadLocalStorage('ebano-sw-enable-local');
        const query = window.location?.search ?? '';
        const queryEnables = typeof query === 'string' && /(?:^|[?&])sw=on(?:&|$)/i.test(query);
        if (enableLocalFlag === 'true' || queryEnables) {
            return true;
        }
        console.info('Service worker registration skipped on localhost. Set localStorage ebano-sw-enable-local=true to override.');
        return false;
    }

    return true;
}

let serviceWorkerRegistrationSetup = false;

// Enhanced service worker registration with proper error handling and lifecycle management
function registerServiceWorker() {
    if (!('serviceWorker' in navigator)) {
        console.warn('Service workers are not supported in this browser');
        return;
    }

    if (!shouldRegisterServiceWorker()) {
        return;
    }

    if (serviceWorkerRegistrationSetup) {
        return;
    }

    serviceWorkerRegistrationSetup = true;

    const startRegistration = async () => {
        if (document.readyState !== 'complete') {
            return;
        }

        window.removeEventListener('load', startRegistration);

        try {
            await initializeServiceWorker();
        } catch (error) {

