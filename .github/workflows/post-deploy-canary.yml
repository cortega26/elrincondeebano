name: Post-Deploy Canary

on:
  pull_request:
    branches: ['main']
  workflow_run:
    workflows: ['Deploy static content to Pages']
    types: [completed]
    branches: ['main']
  workflow_dispatch:
    inputs:
      base_url:
        description: 'HTTPS URL for live probe (manual, allowed network only)'
        required: true
        default: 'https://www.elrincondeebano.com'
      category_path:
        description: 'Optional category page path (e.g. /pages/cervezas.html)'
        required: false
        default: ''
      timeout_ms:
        description: 'Fetch timeout per probe (milliseconds)'
        required: false
        default: '15000'
      deploy_sha:
        description: 'Commit SHA containing canary scripts (optional)'
        required: false
        default: ''
      run_live_probe:
        description: 'Run live production probe from an allowed self-hosted runner'
        required: true
        type: boolean
        default: false
      rollback_on_failure:
        description: 'If true, deploy rollback_ref when live probe fails (manual dispatch only)'
        required: true
        type: boolean
        default: false
      rollback_ref:
        description: 'Git ref to redeploy for rollback (required when rollback_on_failure=true)'
        required: false
        default: ''
      confirm_rollback:
        description: 'Safety confirmation phrase: ROLLBACK'
        required: false
        default: ''

permissions:
  contents: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  canary-pr-verify:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
        with:
          persist-credentials: false
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: '22.x'
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Verify canary contract tests
        run: node --test test/post-deploy-canary.test.js

  artifact-canary:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    outputs:
      deploy_sha: ${{ steps.meta.outputs.deploy_sha }}
      base_url: ${{ steps.meta.outputs.base_url }}
      category_path: ${{ steps.meta.outputs.category_path }}
      timeout_ms: ${{ steps.meta.outputs.timeout_ms }}
    steps:
      - name: Resolve canary metadata
        id: meta
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BASE_URL="${{ inputs.base_url }}"
            CATEGORY_PATH="${{ inputs.category_path }}"
            TIMEOUT_MS="${{ inputs.timeout_ms }}"
            DEPLOY_SHA="${{ inputs.deploy_sha }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            BASE_URL="https://www.elrincondeebano.com"
            CATEGORY_PATH=""
            TIMEOUT_MS="15000"
            DEPLOY_SHA="${{ github.event.workflow_run.head_sha }}"
          else
            BASE_URL="https://www.elrincondeebano.com"
            CATEGORY_PATH=""
            TIMEOUT_MS="15000"
            DEPLOY_SHA="${{ github.sha }}"
          fi

          if [ -z "$DEPLOY_SHA" ]; then
            DEPLOY_SHA="${{ github.sha }}"
          fi

          echo "base_url=$BASE_URL" >> "$GITHUB_OUTPUT"
          echo "category_path=$CATEGORY_PATH" >> "$GITHUB_OUTPUT"
          echo "timeout_ms=$TIMEOUT_MS" >> "$GITHUB_OUTPUT"
          echo "deploy_sha=$DEPLOY_SHA" >> "$GITHUB_OUTPUT"

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
        with:
          ref: ${{ steps.meta.outputs.deploy_sha }}
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: '22.x'
          cache: npm
          cache-dependency-path: |
            package-lock.json
            astro-poc/package-lock.json

      - name: Install dependencies
        run: |
          npm ci
          npm ci --prefix astro-poc

      - name: Build Astro storefront (artifact contract scope)
        run: npm --prefix astro-poc run build

      - name: Validate asset contract
        run: npm --prefix astro-poc run assets:validate

      - name: Validate artifact contract
        run: npm --prefix astro-poc run contract:artifacts

      - name: Write artifact canary report
        shell: bash
        run: |
          mkdir -p reports/canary
          cat > reports/canary/artifact-canary.json <<JSON
          {
            "mode": "artifact-contract",
            "baseUrl": "${{ steps.meta.outputs.base_url }}",
            "deploySha": "${{ steps.meta.outputs.deploy_sha }}",
            "generatedAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "checks": [
              "astro build",
              "assets:validate",
              "contract:artifacts"
            ]
          }
          JSON

      - name: Upload artifact canary report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: post-deploy-artifact-canary
          path: reports/canary
          if-no-files-found: error

      - name: Write canary summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Post-Deploy Canary (Artifact Mode)"
            echo ""
            echo "- Deploy SHA: ${{ steps.meta.outputs.deploy_sha }}"
            echo "- Base URL metadata: ${{ steps.meta.outputs.base_url }}"
            echo "- Mode: artifact-contract (no live network probe on GitHub-hosted runners)"
            echo ""
            if [ "${{ job.status }}" = "success" ]; then
              echo "Result: ✅ Artifact contract checks passed."
            else
              echo "Result: ❌ Artifact contract checks failed."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  live-probe:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_live_probe == true }}
    needs: artifact-canary
    runs-on:
      - self-hosted
      - linux
      - x64
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
        with:
          ref: ${{ needs.artifact-canary.outputs.deploy_sha }}
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: '22.x'
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run live canary probes (allowed network)
        shell: bash
        run: |
          mkdir -p reports/canary
          node tools/post-deploy-canary.mjs \
            --base-url "${{ needs.artifact-canary.outputs.base_url }}" \
            --timeout-ms "${{ needs.artifact-canary.outputs.timeout_ms }}" \
            --category-path "${{ needs.artifact-canary.outputs.category_path }}" \
            --report reports/canary/live-probe.json

      - name: Upload live probe report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: post-deploy-live-probe
          path: reports/canary
          if-no-files-found: error

      - name: Write live probe summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Post-Deploy Canary (Live Probe)"
            echo ""
            echo "- Base URL: ${{ needs.artifact-canary.outputs.base_url }}"
            echo "- Category path: ${{ needs.artifact-canary.outputs.category_path || '(auto from sitemap)' }}"
            echo "- Timeout (ms): ${{ needs.artifact-canary.outputs.timeout_ms }}"
            echo "- Deploy SHA: ${{ needs.artifact-canary.outputs.deploy_sha }}"
            echo "- Runner: self-hosted (allowed network)"
            echo ""
            if [ "${{ job.status }}" = "success" ]; then
              echo "Result: ✅ Live probes passed."
            else
              echo "Result: ❌ Live probes failed."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  rollback:
    needs: [artifact-canary, live-probe]
    if: ${{ always() && github.event_name == 'workflow_dispatch' && inputs.rollback_on_failure == true && needs.live-probe.result == 'failure' && inputs.rollback_ref != '' && inputs.confirm_rollback == 'ROLLBACK' }}
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout rollback ref
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
        with:
          ref: ${{ inputs.rollback_ref }}
          persist-credentials: false

      - name: Set deterministic build environment
        run: |
          echo "TZ=UTC" >> $GITHUB_ENV
          echo "LC_ALL=C.UTF-8" >> $GITHUB_ENV
          echo "LANG=C.UTF-8" >> $GITHUB_ENV
          echo "CFIMG_ENABLE=1" >> $GITHUB_ENV
          echo "SOURCE_DATE_EPOCH=$(git log -1 --format=%ct)" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: '22.x'
          cache: npm
          cache-dependency-path: |
            package-lock.json
            astro-poc/package-lock.json

      - name: Install dependencies
        run: |
          npm ci
          npm ci --prefix astro-poc

      - name: Build Astro storefront for rollback ref
        run: npm --prefix astro-poc run build

      - name: Setup Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5

      - name: Upload rollback artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v3
        with:
          path: astro-poc/dist

      - name: Deploy rollback to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4
