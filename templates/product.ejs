<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="<%= product.description %> - Disponible en El Rincón de Ébano. <% if (product.discount) { %>¡En oferta!<% } %> Entrega inmediata.">
    <link rel="canonical" href="https://elrincondeebano.com/productos/<%= product.slug %>.html">
    <link rel="manifest" href="/app.webmanifest">
    <script src="../assets/js/csp.js"></script>
    <title><%= product.name %> - El Rincón de Ébano</title>
    <link rel="icon" type="image/x-icon" href="../assets/images/web/favicon.ico">
    
    <!-- Performance optimizations -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="//www.googletagmanager.com">
    
    <!-- Critical CSS -->
    <link rel="stylesheet" href="../assets/css/critical.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.8/purify.min.js" integrity="sha384-AsiVBlzbaNOq8OOKcXm2ZVjjKJwiQ9UmzLwfetDjC74OMQdkb6vBHH5QRJH3x1SE" crossorigin="anonymous"></script>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="../<%= product.image_path %>" as="image" fetchpriority="high">
    <link rel="preload" href="../assets/js/script.min.js" as="script">
    
    <!-- Deferred non-critical CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" media="print" data-defer>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" media="print" data-defer>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" media="print" data-defer>
    <link rel="stylesheet" href="../assets/css/style.min.css" media="print" data-defer>
    
    <!-- Product-specific structured data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "Product",
      "name": "<%= product.name %>",
      "image": "https://elrincondeebano.com/<%= product.image_path.replace(/^\//, '') %>",
      "description": "<%= product.description %>",
      "brand": "<%= product.brand || 'Genérico' %>",
      "category": "<%= product.category %>",
      "sku": "<%= generateStableId(product) %>",
      "offers": {
        "@type": "Offer",
        "price": "<%= product.discount ? product.price - product.discount : product.price %>",
        "priceCurrency": "CLP",
        "availability": "https://schema.org/InStock",
        "priceValidUntil": "<%= new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0] %>",
        "seller": {
          "@type": "Organization",
          "name": "El Rincón de Ébano",
          "telephone": "+56951118901"
        }
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.5",
        "reviewCount": "1"
      }
    }
    </script>
    
    <!-- Open Graph for social media -->
    <meta property="og:title" content="<%= product.name %> - El Rincón de Ébano">
    <meta property="og:description" content="<%= product.description %>">
    <meta property="og:image" content="https://elrincondeebano.com/<%= product.image_path.replace(/^\//, '') %>">
    <meta property="og:type" content="product">
    <meta property="og:url" content="https://elrincondeebano.com/productos/<%= product.slug %>.html">
    <meta property="product:price:amount" content="<%= product.discount ? product.price - product.discount : product.price %>">
    <meta property="product:price:currency" content="CLP">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="<%= product.name %> - El Rincón de Ébano">
    <meta name="twitter:description" content="<%= product.description %>">
    <meta name="twitter:image" content="https://elrincondeebano.com/<%= product.image_path.replace(/^\//, '') %>">
</head>
<body>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H0YG3RTJVM"></script>
    <script src="../assets/js/gtag-init.js"></script>

    <header id="navbar-container" role="banner"></header>
    
    <main class="container my-4" itemscope itemtype="https://schema.org/Product">
        <!-- Breadcrumbs for SEO and UX -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                <li class="breadcrumb-item"><a href="/pages/<%= product.category.toLowerCase().replace(/[^a-z0-9]/g, '') %>.html"><%= product.category %></a></li>
                <li class="breadcrumb-item active" aria-current="page" itemprop="name"><%= product.name %></li>
            </ol>
        </nav>
        
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="position-relative">
                    <% if (product.discount && Number(product.discount) > 0) { %>
                        <span class="position-absolute top-0 start-0 badge bg-danger m-2" style="z-index: 1;">
                            -<%= Math.round((Number(product.discount) / Number(product.price)) * 100) %>%
                        </span>
                    <% } %>
                    <img src="../<%= product.image_path %>" 
                         alt="<%= product.name %>" 
                         class="img-fluid rounded shadow-sm"
                         itemprop="image"
                         style="width: 100%; max-height: 500px; object-fit: contain;">
                </div>
            </div>
            <div class="col-md-6">
                <h1 itemprop="name" class="mb-3"><%= product.name %></h1>
                <p itemprop="description" class="text-muted mb-4"><%= product.description %></p>
                
                <div class="price-section mb-4">
                    <% if (product.discount) { %>
                        <div itemprop="offers" itemscope itemtype="https://schema.org/Offer">
                            <span class="h3 text-success me-3">
                                $<span itemprop="price"><%= (product.price - product.discount).toLocaleString('es-CL') %></span>
                                <meta itemprop="priceCurrency" content="CLP">
                                <meta itemprop="availability" content="https://schema.org/InStock">
                            </span>
                            <span class="h5 text-muted text-decoration-line-through">
                                $<%= product.price.toLocaleString('es-CL') %>
                            </span>
                            <div class="text-success small mt-1">
                                ¡Ahorra $<%= product.discount.toLocaleString('es-CL') %>!
                            </div>
                        </div>
                    <% } else { %>
                        <div itemprop="offers" itemscope itemtype="https://schema.org/Offer">
                            <span class="h3 text-primary">
                                $<span itemprop="price"><%= product.price.toLocaleString('es-CL') %></span>
                                <meta itemprop="priceCurrency" content="CLP">
                                <meta itemprop="availability" content="https://schema.org/InStock">
                            </span>
                        </div>
                    <% } %>
                </div>
                
                <div class="mb-4">
                    <span class="badge bg-success fs-6">
                        <i class="bi bi-check-circle me-1"></i>
                        En Stock - Entrega Inmediata
                    </span>
                </div>
                
                <div class="d-grid gap-2 mb-4">
                    <button class="btn btn-primary btn-lg" onclick="addToCartAndRedirect('<%= generateStableId(product) %>')">
                        <i class="bi bi-cart-plus me-2"></i>
                        Agregar al Carrito
                    </button>
                    <button class="btn btn-success" onclick="orderViaWhatsApp('<%= product.name %>', '<%= product.discount ? product.price - product.discount : product.price %>')">
                        <i class="bi bi-whatsapp me-2"></i>
                        Pedir por WhatsApp
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-info-circle me-2"></i>
                            Información del Producto
                        </h5>
                        <ul class="list-unstyled mb-0">
                            <li><strong>Categoría:</strong> <span itemprop="category"><%= product.category %></span></li>
                            <li><strong>Disponibilidad:</strong> <span class="text-success">Inmediata</span></li>
                            <li><strong>Entrega:</strong> En el edificio Ébano</li>
                            <li><strong>Pago:</strong> Efectivo o Transferencia</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Related products section -->
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-4">Productos Relacionados de <%= product.category %></h3>
                <div id="related-products" class="row">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </main>
    
    <footer id="footer-container" role="contentinfo"></footer>
    
    <script>
        // Product data for JavaScript
        const currentProduct = {
            id: '<%= generateStableId(product) %>',
            name: '<%= product.name %>',
            category: '<%= product.category %>',
            price: <%= product.price %>,
            discount: <%= product.discount || 0 %>,
            image_path: '<%= product.image_path %>'
        };
        
        function addToCartAndRedirect(productId) {
            // Use existing cart functionality
            if (typeof addToCart === 'function') {
                addToCart(currentProduct, 1);
            } else {
                // Fallback: store in localStorage and redirect
                let cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const existingItem = cart.find(item => item.id === productId);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cart.push({ ...currentProduct, id: productId, quantity: 1 });
                }
                localStorage.setItem('cart', JSON.stringify(cart));
            }
            
            // Redirect to category page
            window.location.href = '/pages/<%= product.category.toLowerCase().replace(/[^a-z0-9]/g, '') %>.html';
        }

        function orderViaWhatsApp(productName, price) {
            const message = 'Hola! Me interesa el producto: ' + productName + ' - Precio: $' + price.toLocaleString('es-CL');
            const encodedMessage = encodeURIComponent(message);
            window.open('https://wa.me/56951118901?text=' + encodedMessage, '_blank');
        }
        
        // Load related products when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadRelatedProducts('<%= product.category %>');
        });
        
        async function loadRelatedProducts(category) {
            try {
                const response = await fetch('/_products/product_data.json');
                const data = await response.json();
                const products = data.products || data;

                const relatedProducts = products
                    .filter(p => p.category === category && p.stock && p.name !== '<%= product.name %>')
                    .slice(0, 4);

                const container = document.getElementById('related-products');
                container.innerHTML = relatedProducts.map(function(p) {
                    const price = p.discount ? '$' + (p.price - p.discount).toLocaleString('es-CL') : '$' + p.price.toLocaleString('es-CL');
                    return '<div class="col-md-3 col-6 mb-3">'
                        + '<div class="card h-100">'
                        + '<img src="../' + p.image_path + '" class="card-img-top" alt="' + p.name + '" style="height: 150px; object-fit: contain;">'
                        + '<div class="card-body d-flex flex-column">'
                        + '<h6 class="card-title">' + p.name + '</h6>'
                        + '<p class="card-text small text-muted">' + p.description + '</p>'
                        + '<div class="mt-auto">'
                        + '<div class="price-text">' + price + '</div>'
                        + '</div>'
                        + '</div>'
                        + '</div>'
                        + '</div>';
                }).join('');
            } catch (error) {
                console.error('Error loading related products:', error);
            }
        }
    </script>
    
    <!-- Load remaining JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <script src="../assets/js/script.min.js" defer></script>
</body>
</html>`;

function generateStableId(product) {
    const baseString = `${product.name}-${product.category}`.toLowerCase();
    let hash = 0;
    for (let i = 0; i < baseString.length; i++) {
        const char = baseString.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return `pid-${Math.abs(hash)}`;
}

async function generateProductPages() {
    console.log('🚀 Generating individual product pages...');
    
    // Load product data
    const dataPath = path.join(__dirname, '..', '_products', 'product_data.json');
    
    if (!fs.existsSync(dataPath)) {
        console.error('❌ Product data file not found:', dataPath);
        return;
    }
    
    const data = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
    const products = (data.products || data).filter(product => product.stock === true);
    
    // Create productos directory
    const outputDir = path.join(__dirname, '..', 'productos');
    if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir);
    }
    
    let generatedCount = 0;
    
    // Generate page for each in-stock product
    for (const product of products) {
        try {
            // Create URL-friendly slug
            product.slug = product.name
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
            
            // Generate HTML using EJS
            const html = ejs.render(productPageTemplate, { product, generateStableId });
            
            // Write file
            const outputPath = path.join(outputDir, `${product.slug}.html`);
            fs.writeFileSync(outputPath, html);
            generatedCount++;
            
        } catch (error) {
            console.warn(`⚠️  Failed to generate page for ${product.name}:`, error.message);
        }
    }
    
    console.log(`✅ Generated ${generatedCount} product pages in /productos/`);
}

// Run if called directly
if (process.argv[1] === __filename) {
    generateProductPages();
}

export default generateProductPages;