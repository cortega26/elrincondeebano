<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Rincón de Ébano</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-...">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header id="navbar-container"></header>
    <main data-category="">
        <div class="container my-4">
            <div class="row">
                <div class="col-12">
                    <!-- h1>Tienda Online Ébano</h1 -->
                    <!-- p>Delivery a su puerta, al instante.</p -->
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <select id="sort-options" class="form-control">
                        <option value="name-asc">Ordenar por nombre (A-Z)</option>
                        <option value="name-desc">Ordenar por nombre (Z-A)</option>
                        <option value="price-asc">Ordenar por precio (menor a mayor)</option>
                        <option value="price-desc">Ordenar por precio (mayor a menor)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <input type="text" id="filter-keyword" class="form-control" placeholder="Filtrar por nombre">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-12">
                    <input type="checkbox" id="show-in-stock" checked>
                    <label for="show-in-stock">Mostrar solo productos en stock</label>
                </div>
            </div>
            <div class="row" id="product-container">
                <!-- Productos se cargarán aquí -->
            </div>
        </div>
    </main>
    <footer id="footer-container"></footer>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        $(function() {
            $("#navbar-container").load("navbar.html");
            $("#footer-container").load("footer.html");

            async function fetchProducts() {
                const url = '/netlify/functions';
                console.log('Fetching products from URL:', url);
                const response = await fetch(url);
                console.log('Response status:', response.status);
                const products = await response.json();
                console.log('Fetched products:', products);
                return products;
            }

            function renderProducts(products) {
                const productContainer = $('#product-container');
                productContainer.empty();

                const showInStock = $('#show-in-stock').prop('checked');
                const filteredProducts = showInStock ? products.filter(product => product.stock) : products;

                filteredProducts.forEach(product => {
                    const productHTML = `
                        <div class="producto col-12 col-sm-6 col-md-4 col-lg-3 mb-4">
                            <div class="card">
                                <img src="${product.image}" alt="${product.name}" class="card-img-top">
                                <div class="card-body">
                                    <h3 class="card-title">${product.name}</h3>
                                    <p class="card-text">${product.description}</p>
                                    <span class="precio">$${product.price.toFixed(2)}</span>
                                    <span class="stock">${product.stock ? 'En stock' : 'Agotado'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    productContainer.append(productHTML);
                });
            }

            function sortProducts(products, criterion) {
                return products.sort((a, b) => {
                    if (criterion === 'name-asc') return a.name.localeCompare(b.name);
                    if (criterion === 'name-desc') return b.name.localeCompare(a.name);
                    if (criterion === 'price-asc') return a.price - b.price;
                    if (criterion === 'price-desc') return b.price - a.price;
                });
            }

            function filterProducts(products, keyword) {
                return products.filter(product => product.name.toLowerCase().includes(keyword.toLowerCase()));
            }

            async function initialize() {
                let products = await fetchProducts();

                // Initial render
                renderProducts(products);

                // Handle sorting
                $('#sort-options').on('change', function() {
                    const criterion = $(this).val();
                    const sortedProducts = sortProducts(products, criterion);
                    renderProducts(sortedProducts);
                });

                // Handle filtering
                $('#filter-keyword').on('input', function() {
                    const keyword = $(this).val();
                    const filteredProducts = filterProducts(products, keyword);
                    const sortedFilteredProducts = sortProducts(filteredProducts, $('#sort-options').val());
                    renderProducts(sortedFilteredProducts);
                });

                // Handle in-stock checkbox
                $('#show-in-stock').on('change', function() {
                    renderProducts(products);
                });
            }

            initialize();
        });
    </script>
</body>
</html>
