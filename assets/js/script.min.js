"use strict";const coreLoader={loadComponents:async()=>{const e=document.getElementById("navbar-container"),t=document.getElementById("footer-container");if(!e||!t){console.error("Navbar or footer container not found");return}try{await Promise.all([coreLoader.loadComponent(e,"/pages/navbar.html"),coreLoader.loadComponent(t,"/pages/footer.html")]),console.log("Navbar and footer loaded successfully")}catch(n){console.error("Error loading components:",n)}},loadComponent:async(e,t)=>{if(!e){console.warn(`Container not found for component: ${t}`);return}try{const n=await fetch(t);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=await n.text(),r=new DOMParser().parseFromString(o,"text/html"),i=[];r.querySelectorAll("script").forEach(c=>{c.type==="application/ld+json"&&i.push(c.textContent),c.remove()}),e.innerHTML=r.body?r.body.innerHTML:o;const s=e.querySelector("#current-year");if(s&&(s.textContent=new Date().getFullYear()),i.length){const c=typeof window<"u"&&window.__CSP_NONCE__?window.__CSP_NONCE__:null;i.forEach(d=>{try{const l=document.createElement("script");l.type="application/ld+json",c&&l.setAttribute("nonce",c),l.textContent=d,e.appendChild(l)}catch{}})}}catch(n){console.error("Error loading component:",{component:t,message:n.message}),e.innerHTML=`<div class="alert alert-danger">Error loading ${t}</div>`}},loadProducts:async()=>{const e=document.getElementById("product-container");if(!e)return console.error("Product container not found"),[];try{const t=localStorage.getItem("productDataVersion"),n=t?`/_products/product_data.json?v=${encodeURIComponent(t)}`:"/_products/product_data.json",o=await fetch(n,{cache:"no-store",headers:{Accept:"application/json"}});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);let r=(await o.json()).products||[];return r=r.map(i=>({...i,id:coreLoader.generateStableId(i),name:coreLoader.sanitizeHTML(i.name),description:coreLoader.sanitizeHTML(i.description),category:coreLoader.sanitizeHTML(i.category)})),r}catch(t){return console.error("Error loading products:",t),e.innerHTML='<div class="alert alert-danger">Error loading products</div>',[]}},generateStableId:e=>{const t=`${e.name}-${e.category}`.toLowerCase();let n=0;for(let o=0;o<t.length;o++){const a=t.charCodeAt(o);n=(n<<5)-n+a,n=n&n}return`pid-${Math.abs(n)}`},sanitizeHTML:e=>{const t=document.createElement("div");return t.textContent=e,t.innerHTML}},enhancedUtils={normalize:e=>{if(!e)return"";try{return String(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"").toLowerCase()}catch{return String(e).toLowerCase()}},smoothScroll:(e,t=0)=>{const n=e.offsetTop-t;window.scrollTo({top:n,behavior:"smooth"})},debounce:(e,t)=>{let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>e.apply(void 0,o),t)}},isInViewport:e=>{const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}},productAnimations={init:()=>{document.querySelectorAll(".producto").forEach((t,n)=>{t.style.animationDelay=`${n*.1}s`,t.classList.add("fade-in-up"),t.addEventListener("mouseenter",()=>{productAnimations.onHover(t)}),t.addEventListener("mouseleave",()=>{productAnimations.onLeave(t)})})},onHover:e=>{const t=e.querySelector("img"),n=e.querySelector(".card");t&&(t.style.transform="scale(1.05)"),n&&(n.style.transform="translateY(-8px)")},onLeave:e=>{const t=e.querySelector("img"),n=e.querySelector(".card");t&&(t.style.transform="scale(1)"),n&&(n.style.transform="translateY(0)")}},enhancedSearch={init:()=>{const e=document.getElementById("filter-keyword"),t=document.getElementById("sort-options");e&&e.addEventListener("input",enhancedUtils.debounce(enhancedSearch.handleSearch,300)),t&&t.addEventListener("change",enhancedSearch.handleSort)},handleSearch:e=>{const t=e.target.value.toLowerCase().trim(),n=document.getElementById("product-container");t.length>0?(enhancedLoading.show(n),setTimeout(()=>{enhancedSearch.filterProducts(t),enhancedLoading.hide(n)},300)):enhancedSearch.filterProducts(t)},handleSort:()=>{const e=document.getElementById("sort-options").value,t=document.getElementById("product-container");enhancedLoading.show(t),setTimeout(()=>{enhancedSearch.sortProducts(e),enhancedLoading.hide(t)},300)},filterProducts:e=>{const t=window.appState?.products||[];if(!document.getElementById("product-container"))return;const o=t.filter(a=>{const r=a.name?.toLowerCase()||"",i=a.description?.toLowerCase()||"";return r.includes(e)||i.includes(e)});renderProducts(o)},sortProducts:e=>{const n=[...window.appState?.products||[]].sort((o,a)=>{switch(e){case"name-asc":return o.name.localeCompare(a.name);case"name-desc":return a.name.localeCompare(o.name);case"price-asc":return o.price-a.price;case"price-desc":return a.price-o.price;default:return 0}});renderProducts(n)}},enhancedLoading={show:e=>{e&&(e.innerHTML=`
            <div class="loading-container">
                <div class="loading-skeleton"></div>
                <div class="loading-skeleton"></div>
                <div class="loading-skeleton"></div>
                <div class="loading-skeleton"></div>
            </div>
        `)},hide:e=>{if(!e)return;e.querySelectorAll(".loading-skeleton").forEach(n=>n.remove())}},readCart=()=>{try{const e=localStorage.getItem("cart");return e?JSON.parse(e):[]}catch{return[]}},writeCart=e=>{try{localStorage.setItem("cart",JSON.stringify(e))}catch{}window.appState&&(window.appState.cart=e);const t=document.getElementById("cart-count");if(t){const n=e.reduce((o,a)=>o+(Number(a.quantity)||0),0);t.textContent=String(n),t.setAttribute("aria-label",`${n} items in cart`)}},getCartQuantityById=e=>{const n=readCart().find(o=>o.id===e);return n&&Number(n.quantity)||0},updateCartQuantity=(e,t)=>{let n=readCart();const o=n.findIndex(a=>a.id===e);if(t<=0)o!==-1&&n.splice(o,1);else if(o!==-1)n[o].quantity=t;else{const a=(window.appState?.products||[]).find(r=>r.id===e);a&&n.push({...a,quantity:t})}writeCart(n),updateProductCardState(e)},updateProductCardState=e=>{const t=document.querySelector(`.cart-controls[data-product-id="${e}"]`);if(!t)return;const n=t.querySelector(".add-to-cart-btn"),o=t.querySelector(".quantity-controls"),a=t.querySelector(".quantity-input"),r=getCartQuantityById(e);r>0?(a&&(a.value=r),n?.classList.add("d-none"),o?.classList.remove("d-none")):(o?.classList.add("d-none"),n?.classList.remove("d-none"))},renderProducts=e=>{const t=document.getElementById("product-container");if(!t)return;if(e.length===0){t.innerHTML='<div class="alert alert-info">No products found</div>';return}const n=document.createDocumentFragment();e.forEach((o,a)=>{const r=document.createElement("div");r.className="producto col-12 col-sm-6 col-md-4 col-lg-3 mb-4",r.style.animationDelay=`${a*.1}s`;const i=o.price-(o.discount||0),s=o.image_path.replace(/^\/?assets\/images\//,""),c=`assets/images/variants/w200/images/${s}`,d=`assets/images/variants/w400/images/${s}`;r.innerHTML=`
            <div class="card h-100">
                <img src="${d}" srcset="${c} 200w, ${d} 400w" sizes="(max-width: 400px) 100vw, 400px" alt="${o.name}" class="card-img-top" loading="lazy" decoding="async" width="400" height="400">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${o.name}</h5>
                    <p class="card-text flex-grow-1">${o.description}</p>
                    <div class="mt-auto">
                        <div class="price-container">
                            ${o.discount?`
                                <span class="text-danger fw-bold">$${i.toLocaleString()}</span>
                                <span class="text-muted text-decoration-line-through">$${o.price.toLocaleString()}</span>
                            `:`
                                <span class="fw-bold">$${o.price.toLocaleString()}</span>
                            `}
                        </div>
                        <div class="cart-controls mt-2" data-product-id="${o.id}">
                            <button class="btn btn-primary add-to-cart-btn w-100" data-product-id="${o.id}" aria-label="Agregar ${o.name} al carrito">
                                Agregar al carrito
                            </button>
                            <div class="quantity-controls d-none mt-2" role="group" aria-label="Cantidad para ${o.name}">
                                <button class="btn btn-outline-secondary btn-sm decrease-qty" aria-label="Disminuir">-</button>
                                <input type="number" class="form-control form-control-sm quantity-input mx-2" data-product-id="${o.id}" value="1" min="1" max="50" aria-label="Cantidad">
                                <button class="btn btn-outline-secondary btn-sm increase-qty" aria-label="Aumentar">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,n.appendChild(r)}),t.innerHTML="",t.appendChild(n),e.forEach(o=>updateProductCardState(o.id)),productAnimations.init()};function attachAddToCartHandler(){const e=document.getElementById("product-container");!e||e.dataset.cartHandler==="1"||(e.dataset.cartHandler="1",e.addEventListener("click",t=>{const n=t.target.closest(".add-to-cart-btn");if(!n)return;const o=n.getAttribute("data-product-id");o&&typeof window.addToCart=="function"&&(window.addToCart(o),updateProductCardState(o))}))}function attachQuantityHandlers(){const e=document.getElementById("product-container");!e||e.dataset.qtyHandler==="1"||(e.dataset.qtyHandler="1",e.addEventListener("click",t=>{const n=t.target.closest(".increase-qty"),o=t.target.closest(".decrease-qty");if(!n&&!o)return;const a=t.target.closest(".cart-controls");if(!a)return;const r=a.getAttribute("data-product-id"),i=a.querySelector(".quantity-input");let s=parseInt(i.value,10)||0;s=s+(n?1:-1),s=Math.max(0,Math.min(50,s)),updateCartQuantity(r,s)}),e.addEventListener("change",t=>{const n=t.target.closest(".quantity-input");if(!n)return;const a=n.closest(".cart-controls")?.getAttribute("data-product-id");if(!a)return;let r=parseInt(n.value,10)||0;r=Math.max(0,Math.min(50,r)),updateCartQuantity(a,r)}))}window.addToCart=e=>{const t=window.appState.products.find(a=>a.id===e);if(!t)return;let n=readCart();const o=n.find(a=>a.id===e);o?o.quantity=Math.min(o.quantity+1,50):n.push({...t,quantity:1}),writeCart(n);try{alert(`${t.name} agregado al carrito`)}catch{}},window.appState={products:[],cart:[],init:async()=>{if(console.log("Initializing enhanced app..."),typeof DOMPurify>"u")try{await new Promise((t,n)=>{const o=document.createElement("script");o.src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.8/purify.min.js",o.integrity="sha384-AsiVBlzbaNOq8OOKcXm2ZVjjKJwiQ9UmzLwfetDjC74OMQdkb6vBHH5QRJH3x1SE",o.crossOrigin="anonymous";try{window&&window.__CSP_NONCE__&&o.setAttribute("nonce",window.__CSP_NONCE__)}catch{}o.onload=t,o.onerror=n,document.head.appendChild(o)})}catch(t){console.error("Failed to load DOMPurify:",t);return}await coreLoader.loadComponents();const e=await coreLoader.loadProducts();window.appState.products=e;try{const t=readCart();if(t.length&&e.length){const n=new Map(e.map(a=>[enhancedUtils.normalize(a.name),a]));let o=!1;t.forEach(a=>{if(!e.some(i=>i.id===a.id)){const i=n.get(enhancedUtils.normalize(a.name));i&&(a.id=i.id,o=!0)}}),o&&writeCart(t)}}catch{}productAnimations.init(),enhancedSearch.init();try{writeCart(readCart())}catch{}renderProducts(e),typeof window<"u"&&(window.__APP_READY__=!0),attachAddToCartHandler(),attachQuantityHandlers(),window.appState.cart=readCart(),window.appState.cart.forEach(t=>updateProductCardState(t.id)),console.log("Enhanced app initialized successfully")}};const initEnhancedApp=()=>{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",window.appState.init):window.appState.init()};initEnhancedApp();
