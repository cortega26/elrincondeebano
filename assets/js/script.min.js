"use strict";(()=>{var ce=(n,r)=>()=>(r||n((r={exports:{}}).exports,r),r.exports);var be=ce((Ee,_)=>{var N={path:"/service-worker.js",scope:"/",updateCheckInterval:3e5};function G(){if(!("serviceWorker"in navigator)){console.warn("Service workers are not supported in this browser");return}window.addEventListener("load",async()=>{try{se()}catch(n){console.error("Service Worker initialization failed:",n),fe("Failed to initialize service worker. Some features may not work offline.")}})}async function se(){try{let n=await navigator.serviceWorker.register(N.path,{scope:N.scope});console.log("ServiceWorker registered successfully:",n.scope),de(n),le(n),ue(),pe()}catch(n){throw console.error("ServiceWorker registration failed:",n),n}}function de(n){n.addEventListener("updatefound",()=>{let r=n.installing;r.addEventListener("statechange",()=>{r.state==="installed"&&navigator.serviceWorker.controller&&r.postMessage({type:"SKIP_WAITING"})})})}function le(n){K(n),setInterval(()=>{K(n)},N.updateCheckInterval)}async function K(n){try{await n.update();let r=await fetch("/_products/product_data.json",{headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});if(r.ok){let p=(await r.json()).version,u=localStorage.getItem("productDataVersion");p!==u&&(n.active?.postMessage({type:"INVALIDATE_PRODUCT_CACHE"}),localStorage.setItem("productDataVersion",p),me(null,"New product data available"))}}catch(r){console.warn("Update check failed:",r)}}function ue(){let n=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{n||(n=!0,window.location.reload())})}function pe(){let n=()=>{let r=document.getElementById("offline-indicator");r&&(r.style.display=navigator.onLine?"none":"block"),navigator.onLine||ge("You are currently offline. Some features may be limited.")};window.addEventListener("online",n),window.addEventListener("offline",n),n()}function me(n,r="Una versi\xF3n est\xE1 disponible"){let d=W(r,"Actualizar ahora","Despu\xE9s",()=>{n?n.postMessage({type:"SKIP_WAITING"}):window.location.reload()});H(d)}function fe(n){let r=W(n,"Reload","Dismiss",()=>window.location.reload());H(r)}function ge(n){let r=W(n,"Retry","Dismiss",()=>window.location.reload());H(r)}function W(n,r,d,p){let u=document.createElement("div");return u.className="notification-toast",u.setAttribute("role","alert"),u.setAttribute("aria-live","polite"),u.innerHTML=`
        <div class="notification-content">
            <p>${n}</p>
            <div class="notification-actions">
                <button class="primary-action">${r}</button>
                <button class="secondary-action">${d}</button>
            </div>
        </div>
    `,u.querySelector(".primary-action").addEventListener("click",()=>{p(),u.remove()}),u.querySelector(".secondary-action").addEventListener("click",()=>{u.remove()}),u}function H(n){let r=document.querySelector(".notification-toast");r&&r.remove(),document.body.appendChild(n),setTimeout(()=>{document.body.contains(n)&&n.remove()},300*1e3)}typeof navigator<"u"&&"serviceWorker"in navigator&&G();var ye=(n,r=100)=>{let d=new Map;return(...p)=>{let u=JSON.stringify(p);if(d.has(u))return d.get(u);let v=n(...p);if(d.size>=r){let b=d.keys().next().value;d.delete(b)}return d.set(u,v),v}},he=(n,r)=>{let d;return(...p)=>{clearTimeout(d),d=setTimeout(()=>n(...p),r)}},J=n=>{let r=`${n.name}-${n.category}`.toLowerCase(),d=0;for(let p=0;p<r.length;p++){let u=r.charCodeAt(p);d=(d<<5)-d+u,d=d&d}return`pid-${Math.abs(d)}`},D=n=>{let r=document.createElement("div");return r.textContent=n,r.innerHTML},ve=async()=>{try{let n=await fetch("/_products/product_data.json",{headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});if(!n.ok)throw new Error(`HTTP error. Status: ${n.status}`);return(await n.json()).products.map(d=>({...d,id:J(d),name:D(d.name),description:D(d.description),category:D(d.category)}))}catch(n){throw console.error("Error al obtener productos:",n),g(`Error al cargar los productos. Por favor, verifique su conexi\xF3n a internet e int\xE9ntelo de nuevo. (Error: ${n.message})`),n}},s=(n,r={},d=[])=>{let p=document.createElement(n);return Object.entries(r).forEach(([u,v])=>{u==="text"?p.textContent=v:p.setAttribute(u,v)}),d.forEach(u=>{typeof u=="string"?p.appendChild(document.createTextNode(u)):p.appendChild(u)}),p},g=n=>{let r=s("div",{class:"error-message",role:"alert"},[s("p",{},[n]),s("button",{class:"retry-button"},["Intentar nuevamente"])]),d=document.getElementById("product-container");d?(d.innerHTML="",d.appendChild(r),r.querySelector(".retry-button").addEventListener("click",X)):console.error("Contenedor de productos no encontrado")};typeof window<"u"&&window.addEventListener("error",n=>{console.error("Error global:",n.error),g("Ocurri\xF3 un error inesperado. Por favor, recarga la p\xE1gina.")});var X=async()=>{if(console.log("Initializing app..."),typeof DOMPurify>"u")try{await new Promise((e,a)=>{let o=document.createElement("script");o.src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.8/purify.min.js",o.onload=e,o.onerror=a,document.head.appendChild(o)})}catch(e){console.error("Failed to load DOMPurify:",e),g("Failed to load required dependencies. Please refresh the page.");return}let n=document.getElementById("navbar-container"),r=document.getElementById("footer-container"),d=document.getElementById("product-container"),p=document.getElementById("sort-options"),u=document.getElementById("filter-keyword"),v=()=>{let e=document.getElementById("filter-discount");if(e)return e;let a=document.querySelector('section[aria-label*="filtrado"], section[aria-label*="Opciones de filtrado"]'),o=a?a.querySelector(".row"):null;if(!o)return null;let i=s("div",{class:"col-12 mt-2"}),t=s("div",{class:"form-check form-switch"}),c=s("input",{class:"form-check-input",type:"checkbox",id:"filter-discount","aria-label":"Mostrar solo productos con descuento"}),l=s("label",{class:"form-check-label",for:"filter-discount"},["Solo productos con descuento"]);return t.appendChild(c),t.appendChild(l),i.appendChild(t),o.appendChild(i),c},b=[],f=JSON.parse(localStorage.getItem("cart"))||[],M=()=>{let e=document.getElementById("offline-indicator");e&&(e.style.display=navigator.onLine?"none":"block"),navigator.onLine||console.log("App is offline. Using cached data if available.")},j=async(e,a)=>{if(!e){console.warn(`Contenedor no encontrado para el componente: ${a}`);return}try{let o=await fetch(a);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);let i=await o.text(),t=DOMPurify.sanitize(i,{USE_PROFILES:{html:!0},ALLOWED_TAGS:["div","span","p","h1","h2","h3","h4","h5","h6","ul","ol","li","a","img","br","strong","em","button","nav","footer","header","main","section"],ALLOWED_ATTR:["href","src","alt","class","id","style","aria-label","role","type","data-bs-toggle","data-bs-target","aria-controls","aria-expanded"]});e.innerHTML="";let l=new DOMParser().parseFromString(t,"text/html");Array.from(l.body.children).forEach(m=>{e.appendChild(m.cloneNode(!0))})}catch(o){throw console.error("Error al cargar componente:",{component:a,message:o.message}),o}},Y=async()=>{try{await Promise.all([j(n,"/pages/navbar.html"),j(r,"/pages/footer.html")]),console.log("Components loaded successfully")}catch(e){console.error("Error al cargar componentes:",e),g("Error al cargar los componentes de la p\xE1gina. Por favor, actualice la p\xE1gina o verifique su conexi\xF3n a internet.")}},Z=(e,a,o="CLP")=>{let i=new Intl.NumberFormat("es-CL",{style:"currency",currency:o,minimumFractionDigits:0}),t=i.format(e);if(a){let c=e-a,l=i.format(c);return s("div",{class:"precio-container"},[s("span",{class:"precio-descuento","aria-label":"Precio con descuento"},[l]),s("span",{class:"precio-original","aria-label":"Precio original"},[s("span",{class:"tachado"},[t])])])}return s("div",{class:"precio-container"},[s("span",{class:"precio","aria-label":"Precio"},[t])])},F=e=>{let a=s("div",{class:"quantity-control"}),o=s("button",{class:"quantity-btn","aria-label":"Decrease quantity"},["-"]),i=s("button",{class:"quantity-btn","aria-label":"Increase quantity"},["+"]),t=s("input",{type:"number",class:"quantity-input",value:Math.max(O(e.id),1),min:"1",max:"50","aria-label":"Quantity","data-id":e.id});return o.addEventListener("click",()=>k(e,-1)),i.addEventListener("click",()=>k(e,1)),t.addEventListener("change",c=>{let l=parseInt(c.target.value,10),m=O(e.id);k(e,l-m)}),a.appendChild(o),a.appendChild(t),a.appendChild(i),a},O=e=>{let a=f.find(o=>o.id===e);return a?a.quantity:0},ee=e=>{let a=document.createDocumentFragment(),o=window.location.pathname.includes("/pages/");e.forEach(t=>{let{id:c,name:l,description:m,image_path:C,price:T,discount:I,stock:z}=t,B=s("div",{class:`producto col-12 col-sm-6 col-md-4 col-lg-3 mb-4 ${z?"":"agotado"}`,"aria-label":`Product: ${l}`}),S=s("div",{class:"card"});if(I&&Number(I)>0){let y=Math.round(Number(I)/Number(T)*100),w=s("span",{class:"discount-badge badge bg-danger","aria-label":"Producto en oferta"},[`-${isFinite(y)?y:0}%`]);S.appendChild(w)}let E;o?E=`../${C.replace(/^\//,"")}`:E=C;let x=s("img",{"data-src":E,alt:l,class:"card-img-top lazyload"});S.appendChild(x);let h=s("div",{class:"card-body"});h.appendChild(s("h3",{class:"card-title"},[l])),h.appendChild(s("p",{class:"card-text"},[m])),h.appendChild(Z(T,I));let Q=f.find(y=>y.id===c),V=Q?Q.quantity:0;if(V>0){let y=F(t);h.appendChild(y);let w=y.querySelector(".quantity-input");w&&(w.value=V)}else{let y=s("button",{class:"btn btn-primary add-to-cart-btn mt-2","data-id":c,"aria-label":`Add ${l} to cart`},["Agregar al carrito"]);y.addEventListener("click",()=>{R(t,1);let w=F(t);y.replaceWith(w),w.classList.add("fade-in-up")}),h.appendChild(y)}S.appendChild(h),B.appendChild(S),a.appendChild(B)});let i=document.getElementById("product-container");i.innerHTML="",i.appendChild(a),te()},te=()=>{let e=new IntersectionObserver((a,o)=>{a.forEach(i=>{if(i.isIntersecting){let t=i.target;t.src=t.dataset.src,t.classList.remove("lazyload"),o.unobserve(t)}})},{rootMargin:"100px"});document.querySelectorAll("img.lazyload").forEach(a=>e.observe(a))},ne=(e,a,o,i=!1)=>e.filter(t=>(t.name.toLowerCase().includes(a.toLowerCase())||t.description.toLowerCase().includes(a.toLowerCase()))&&t.stock&&(!i||t.discount&&Number(t.discount)>0)).sort((t,c)=>ae(t,c,o)),ae=(e,a,o)=>{if(!o||o==="original")return e.originalIndex-a.originalIndex;let[i,t]=o.split("-"),c=i==="price"?e.price-(e.discount||0):e.name.toLowerCase(),l=i==="price"?a.price-(a.discount||0):a.name.toLowerCase();return t==="asc"?c<l?-1:c>l?1:0:l<c?-1:l>c?1:0},oe=ye(ne),q=()=>{try{let e=p.value||"original",a=u.value.trim(),o=document.getElementById("filter-discount")?.checked||!1,i=oe(b,a,e,o);ee(i)}catch(e){console.error("Error al actualizar visualizaci\xF3n de productos:",e),g("Error al actualizar la visualizaci\xF3n de productos. Por favor, intenta m\xE1s tarde.")}},A=he(q,300),P=()=>{let e=document.getElementById("cart-count"),a=f.reduce((o,i)=>o+i.quantity,0);e.textContent=a,e.setAttribute("aria-label",`${a} items in cart`)},R=(e,a)=>{try{let o=f.find(t=>t.id===e.id);o?o.quantity=Math.min(o.quantity+a,50):f.push({id:e.id,name:e.name,description:e.description,price:e.price,discount:e.discount,image_path:e.image_path,quantity:Math.min(a,50),category:e.category,stock:e.stock}),$(),P(),L();let i=document.querySelector(`[data-id="${e.id}"].quantity-input`);i&&(i.value=Math.max(O(e.id),1))}catch(o){console.error("Error al agregar al carrito:",o),g("Error al agregar el art\xEDculo al carrito. Por favor, intenta nuevamente.")}},U=e=>{try{f=f.filter(a=>a.id!==e),$(),P(),L(),q()}catch(a){console.error("Error al eliminar del carrito:",a),g("Error al eliminar el art\xEDculo del carrito. Por favor, intenta nuevamente.")}},k=(e,a)=>{try{let o=f.find(t=>t.id===e.id),i=o?o.quantity+a:1;if(i<=0)U(e.id),q();else if(i<=50){o?o.quantity=i:R(e,1),$(),P(),L();let t=document.querySelector(`[data-id="${e.id}"].quantity-input`);t&&(t.value=i,t.classList.add("quantity-changed"),setTimeout(()=>t.classList.remove("quantity-changed"),300))}}catch(o){console.error("Error al actualizar cantidad:",o),g("Error al actualizar la cantidad. Por favor, intenta nuevamente.")}},re=()=>{try{f=[],$(),P(),L(),q()}catch(e){console.error("Error al vaciar el carrito:",e),g("Error al vaciar el carrito. Por favor, int\xE9ntelo de nuevo.")}},$=()=>{try{localStorage.setItem("cart",JSON.stringify(f))}catch(e){console.error("Error al guardar el carrito:",e),g("Error al guardar el carrito. Tus cambios podr\xEDan no persistir.")}},L=()=>{let e=document.getElementById("cart-items"),a=document.getElementById("cart-total");e.innerHTML="";let o=0;f.forEach(t=>{let c=t.price-(t.discount||0),l=s("div",{class:"cart-item mb-3 d-flex align-items-center","aria-label":`Cart item: ${t.name}`,style:"flex-direction: row; align-items: center;"}),m=s("div",{class:"cart-item-content flex-grow-1"});m.appendChild(s("div",{class:"fw-bold mb-1"},[t.name]));let C=s("div",{class:"mb-2"}),T=s("button",{class:"btn btn-sm btn-secondary decrease-quantity","data-id":t.id,"aria-label":`Disminuir cantidad de ${t.name}`},["-"]),I=s("button",{class:"btn btn-sm btn-secondary increase-quantity","data-id":t.id,"aria-label":`Aumentar cantidad de ${t.name}`},["+"]),z=s("span",{class:"mx-2 item-quantity","aria-label":`Cantidad de ${t.name}`},[t.quantity.toString()]);C.appendChild(T),C.appendChild(z),C.appendChild(I),m.appendChild(C),m.appendChild(s("div",{class:"text-muted small"},[`Precio: $${c.toLocaleString("es-CL")}`])),m.appendChild(s("div",{class:"fw-bold"},[`Subtotal: $${(c*t.quantity).toLocaleString("es-CL")}`]));let B=s("button",{class:"btn btn-sm btn-danger remove-item mt-2","data-id":t.id,"aria-label":`Eliminar ${t.name} del carrito`},["Eliminar"]);m.appendChild(B);let S=window.location.pathname.includes("/pages/"),E;S?E=`../${t.image_path.replace(/^\//,"")}`:E=t.image_path;let x=s("div",{class:"cart-item-thumbnail",style:"width: 60px; height: 60px; flex-shrink: 0; margin-left: auto;"}),h=s("img",{src:E,alt:t.name,class:"img-fluid rounded",style:"width: 100%; height: 100%; object-fit: cover;"});x.appendChild(h),l.appendChild(m),l.appendChild(x),e.appendChild(l),o+=c*t.quantity}),a.textContent=`Total: $${o.toLocaleString("es-CL")}`,a.setAttribute("aria-label",`Total: $${o.toLocaleString("es-CL")}`);let i=document.getElementById("payment-credit-container");if(i)if(o>=3e4)i.classList.remove("d-none");else{i.classList.add("d-none");let t=i.querySelector("input");t&&(t.checked=!1)}},ie=()=>{let e=document.querySelector('input[name="paymentMethod"]:checked');if(!e){alert("Por favor seleccione un m\xE9todo de pago");return}let a=`Mi pedido:

`;f.forEach(t=>{let c=t.price-(t.discount||0);a+=`${t.name}
`,a+=`Cantidad: ${t.quantity}
`,a+=`Precio unitario: $${c.toLocaleString("es-CL")}
`,a+=`Subtotal: $${(c*t.quantity).toLocaleString("es-CL")}

`});let o=f.reduce((t,c)=>t+(c.price-(c.discount||0))*c.quantity,0);a+=`Total: $${o.toLocaleString("es-CL")}
`,a+=`M\xE9todo de pago: ${e.value}`;let i=encodeURIComponent(a);window.open(`https://wa.me/56951118901?text=${i}`,"_blank")};try{if(await Y(),b=await ve(),b.length===0){g("No hay productos disponibles. Por favor, intenta m\xE1s tarde.");return}let e=document.querySelector("main").dataset.category;e&&(b=b.filter(c=>c.category===e)),p.addEventListener("change",A),u.addEventListener("input",A);let a=v();a&&a.addEventListener("change",A),q(),window.addEventListener("online",M),window.addEventListener("offline",M),M();let o=document.getElementById("cart-icon"),i=document.getElementById("empty-cart"),t=document.getElementById("submit-cart");o.addEventListener("click",()=>{if(typeof window.bootstrap<"u"&&window.bootstrap.Offcanvas){let c=new window.bootstrap.Offcanvas(document.getElementById("cartOffcanvas"));L(),c.show()}else{console.error("Bootstrap Offcanvas no est\xE1 disponible"),L();let c=document.getElementById("cartOffcanvas");c&&c.classList.add("show")}}),i.addEventListener("click",re),t.addEventListener("click",ie),document.getElementById("cart-items").addEventListener("click",c=>{let l=c.target,m=l.closest("[data-id]")?.dataset.id;m&&(l.classList.contains("decrease-quantity")?k({id:m},-1):l.classList.contains("increase-quantity")?k({id:m},1):l.classList.contains("remove-item")&&U(m))}),P(),"performance"in window&&window.addEventListener("load",()=>{let c=performance.getEntriesByType("paint"),l=performance.getEntriesByType("navigation")[0];console.log("First Contentful Paint:",c[0].startTime),console.log("DOM Content Loaded:",l.domContentLoadedEventEnd),console.log("Load Time:",l.loadEventEnd)})}catch(e){console.error("Error al inicializar productos:",e),g("Error al cargar productos. Por favor, int\xE9ntelo m\xE1s tarde.")}};typeof document<"u"&&document.addEventListener("DOMContentLoaded",function(){G(),X().catch(n=>{console.error("Error al inicializar la aplicaci\xF3n:",n),g("Error al inicializar la aplicaci\xF3n. Por favor, actualice la p\xE1gina.")})});typeof _<"u"&&(_.exports={generateStableId:J});typeof document<"u"&&document.addEventListener("DOMContentLoaded",function(){var n=document.createElement("script");n.src="assets/js/cart-enhancements.js",document.body.appendChild(n)})});be();})();
